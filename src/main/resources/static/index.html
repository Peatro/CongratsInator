<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CongratsInator SPA</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #818181;
            padding: 8px;
            text-align: left;
            vertical-align: middle;
        }

        input, button {
            margin: 4px 0;
        }

        img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }
    </style>
</head>
<body>

<h1>CongratsInator SPA</h1>

<h2>Добавить день рождения</h2>
<input id="name" placeholder="Имя">
<input id="birthday" type="date">
<button onclick="addPerson()">Добавить</button>

<h2>Список дней рождения</h2>
<table>
    <thead>
    <tr>
        <th>Фото</th>
        <th>Имя</th>
        <th>Дата</th>
        <th>Действия</th>
    </tr>
    </thead>
    <tbody id="persons-table"></tbody>
</table>

<script>
    const apiUrl = '/api/persons';

    async function fetchPersons() {
        const res = await fetch(apiUrl);
        const data = await res.json();
        const tbody = document.getElementById('persons-table');
        tbody.innerHTML = '';

        data.forEach(p => {
            const tr = document.createElement('tr');
            tr.id = `person-${p.id}`;

            tr.innerHTML = `
                <td>${p.photoUrl ? `<img src="${p.photoUrl}" alt="photo">` : '—'}</td>
                <td>${p.name}</td>
                <td>${p.birthday}</td>
                <td>
                    <input type="file" onchange="uploadPhoto('${p.id}', this.files[0])"><br>
                    <button onclick="deletePerson(${p.id})">Удалить</button>
                </td>
            `;

            tbody.appendChild(tr);
        });
    }

    async function addPerson() {
        const name = document.getElementById('name').value;
        const birthday = document.getElementById('birthday').value;

        if (!name || !birthday) {
            alert('Заполните все поля');
            return;
        }

        await fetch(apiUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, birthday})
        });

        document.getElementById('name').value = '';
        document.getElementById('birthday').value = '';

        fetchPersons();
    }

    async function deletePerson(id) {
        await fetch(`${apiUrl}/${id}`, {method: 'DELETE'});
        fetchPersons();
    }

    async function uploadPhoto(personId, file) {
        console.log('Uploading photo for person ID:', personId, 'File:', file);

        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch(`${apiUrl}/${personId}/photo`, {
            method: 'POST',
            body: formData
        });

        if (!res.ok) {
            console.error('Photo upload failed with status:', res.status);
            alert('Ошибка при загрузке фото');
            return;
        }

        const photoUrl = await res.text();

        // можно сразу обновить картинку в таблице, не дергая весь fetchPersons()
        const tr = document.querySelector(`#person-${personId}`);
        if (tr) {
            const img = tr.querySelector('img');
            if (img) img.src = photoUrl;
            else tr.querySelector('td').innerHTML = `<img src="${photoUrl}" alt="photo">`;
        }
    }

    fetchPersons();
</script>

</body>
</html>
