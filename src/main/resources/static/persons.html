<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CongratsInator — все дни рождения</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #818181;
            padding: 8px;
            text-align: left;
            vertical-align: middle;
        }

        input, button {
            margin: 4px 0;
        }

        img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }

        nav a {
            margin-right: 12px;
        }
    </style>
</head>
<body>

<h1>Все дни рождения</h1>

<nav>
    <a href="/index.html">Главная</a>
    <a href="/persons.html">Все дни рождения</a>
</nav>

<section>
    <h2>Добавить день рождения</h2>
    <input id="name" placeholder="Имя">
    <input id="birthday" type="date">
    <button onclick="addPerson()">Добавить</button>
</section>

<section>
    <h2>Список дней рождения</h2>
    <table>
        <thead>
        <tr>
            <th>Фото</th>
            <th>Имя</th>
            <th>Дата</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody id="persons-table"></tbody>
    </table>
</section>

<script>
    const apiUrl = '/api/persons';

    function formatDateForInput(dateString) {
        if (!dateString) return '';
        return new Date(dateString).toISOString().split('T')[0];
    }

    async function fetchPersons() {
        const res = await fetch(apiUrl);
        if (!res.ok) {
            console.error('Failed to fetch persons:', res.status);
            return;
        }

        const data = await res.json();
        data.sort((a, b) => new Date(a.birthday) - new Date(b.birthday));

        const tbody = document.getElementById('persons-table');
        tbody.innerHTML = '';

        data.forEach(p => {
            const tr = document.createElement('tr');
            tr.id = `person-${p.id}`;

            tr.innerHTML = `
                <td>${p.photoUrl ? `<img src="${p.photoUrl}" alt="photo">` : '—'}</td>
                <td>${p.name}</td>
                <td>${p.birthday}</td>
                <td>
                    <input type="file" onchange="uploadPhoto('${p.id}', this.files[0])"><br>
                    <button onclick="editPerson('${p.id}', '${p.name}', '${p.birthday}')">Редактировать</button>
                    <button onclick="deletePerson('${p.id}')">Удалить</button>
                </td>
            `;

            tbody.appendChild(tr);
        });
    }

    async function addPerson() {
        const name = document.getElementById('name').value.trim();
        const birthday = document.getElementById('birthday').value;

        if (!name || !birthday) {
            alert('Заполните все поля');
            return;
        }

        await fetch(apiUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, birthday})
        });

        document.getElementById('name').value = '';
        document.getElementById('birthday').value = '';

        fetchPersons();
    }

    async function editPerson(id, currentName, currentBirthday) {
        const name = prompt('Новое имя', currentName);
        if (!name) {
            return;
        }

        const birthday = prompt('Новая дата (YYYY-MM-DD)', formatDateForInput(currentBirthday));
        if (!birthday) {
            return;
        }

        await fetch(`${apiUrl}/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, birthday})
        });

        fetchPersons();
    }

    async function deletePerson(id) {
        await fetch(`${apiUrl}/${id}`, {method: 'DELETE'});
        fetchPersons();
    }

    async function uploadPhoto(personId, file) {
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch(`${apiUrl}/${personId}/photo`, {
            method: 'POST',
            body: formData
        });

        if (!res.ok) {
            alert('Ошибка при загрузке фото');
            return;
        }

        const photoUrl = await res.text();

        const tr = document.querySelector(`#person-${personId}`);
        if (tr) {
            const imgTd = tr.querySelector('td');
            if (imgTd) imgTd.innerHTML = `<img src="${photoUrl}" alt="photo">`;
        }
    }

    fetchPersons();
</script>

</body>
</html>